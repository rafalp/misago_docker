#!/bin/bash
# appctl is an utility script for managing your Misago deployment.
# To find out what options are available, run it without any arguments.

# Text styles
RED='\033[0;31m'
BOLD=$(tput bold)
NORMAL=$(tput sgr0)

# Define env paths
# Those are paths to env files created by wizard
misago_env_path="./env/misago.env"
env_paths=(
    $misago_env_path
    "./env/postgres.env"
)

# Utility functions used by action commands
error() {
    echo -e "${RED}Error:${NORMAL} $1"
}

require_setup() {
    for env_path in "${env_paths[@]}"; do
        if [ ! -e $env_path ]; then
            if [[ $1 ]]; then
                error $1
            else
                error "You need to setup your site using \"setup\" option before you will be able to use this option."
            fi
            echo
            exit 1
        fi
    done
}

# Check if user has docker-compose
if ! command -v docker-compose >/dev/null 2>&1; then
    error "You need to have Docker installed to use this tool."
    echo
    echo "Docker release for your system can be downloaded for free from this page:"
    echo "https://www.docker.com/get-started"
    echo
    exit 1
fi

# Commands
intro() {
    echo "Usage: ./appctl [arg] ..."
    echo "Arguments grouped by type:"
    echo
    echo "Setup and upgrade:"
    echo
    echo "    ${BOLD}setup${NORMAL}         setup new Misago site."
    echo
    echo "Docker process:"
    echo
    echo "    ${BOLD}start${NORMAL}         start Misago and other containers."
    echo "    ${BOLD}stop${NORMAL}          stop Misago and other containers."
    echo "    ${BOLD}restart${NORMAL}       stop and start docker containers."
    echo "    ${BOLD}stats${NORMAL}         see list of running docker containers."
    echo
    echo "Change configuration:"
    echo
    echo "    ${BOLD}email${NORMAL}         change email setup."
    echo "    ${BOLD}hostname${NORMAL}      change hostname setup."
    echo "    ${BOLD}locale${NORMAL}        change locale setup."
    echo "    ${BOLD}timezone${NORMAL}      change timezone setup."
    echo "    ${BOLD}debug${NORMAL}         change debug mode."
    echo "    ${BOLD}secret${NORMAL}        reset secret key."
    echo
}

# Handle invalid argument
invalid_argument() {
    echo -e "Invalid argument: ${RED}$1${NORMAL}"
    echo "Please run this script without any arguments to see the list of available arguments."
    exit 1
}

# Run new site setup
setup() {
    # Test if env files already exist
    for env_path in "${env_paths[@]}"; do
        if [ -e $env_path ]; then
            error "Setup appears to already been completed."
            echo
            exit 1
        fi
    done
    # Run wizard to let user create env files
    python3 wizard/setup.py
    # Recheck if user completed setup
    for env_path in "${env_paths[@]}"; do
        if [ ! -e $env_path ]; then
            echo "Setup canceled."
            exit 1
        fi
    done
    # Initialize default database?
    read -p "Do you want to initialize database? [Y/n]: " initialize_default_database
    # Run docker build
    docker-compose build --pull
    if [ "$initialize_default_database" != "n" ]; then
        docker-compose run --rm misago ./.run initialize_default_database
    fi
}

# Start docker containers
start_containers() {
    require_setup
    docker-compose up --detach
}

# Stop docker containers
stop_containers() {
    require_setup
    docker-compose stop
}

# Restart docker containers
restart_containers() {
    require_setup
    docker-compose stop
    docker-compose up --detach
}

# Show stats for running docker containers
show_stats() {
    require_setup
    docker stats
}

# E-mail configuration
change_email() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to change email configuration."
    python3 wizard/email.py
}

# Hostname configuration
change_hostname() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to change hostname configuration."
    python3 wizard/hostname.py
}

# Locale configuration
change_locale() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to change locale configuration."
    python3 wizard/locale.py
}

# Timezone configuration
change_timezone() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to change timezone configuration."
    python3 wizard/timezone.py
}

# Debug configuration
change_debug() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to change debug mode."
    python3 wizard/debug.py
}

# Reset secret key
reset_secret_key() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to reset secret key."
    python3 wizard/secretkey.py
}

# Command dispatcher
if [[ $1 ]]; then
    if [[ $1 = "setup" ]]; then
        setup
    elif [[ $1 = "up" ]]; then
        start_containers
    elif [[ $1 = "start" ]]; then
        start_containers
    elif [[ $1 = "stop" ]]; then
        stop_containers
    elif [[ $1 = "restart" ]]; then
        restart_containers
    elif [[ $1 = "stats" ]]; then
        show_stats
    elif [[ $1 = "email" ]]; then
        change_email
    elif [[ $1 = "hostname" ]]; then
        change_hostname
    elif [[ $1 = "locale" ]]; then
        change_locale
    elif [[ $1 = "timezone" ]]; then
        change_timezone
    elif [[ $1 = "debug" ]]; then
        change_debug
    elif [[ $1 = "secret" ]]; then
        reset_secret_key
    else
        invalid_argument $1
    fi
else
    intro
fi