#!/bin/bash
# appctl is an utility script for managing your Misago deployment.
# To find out what options are available, run it without any arguments.

# Text styles
RED='\033[0;31m'
BOLD=$(tput bold)
NORMAL=$(tput sgr0)

# Define env paths
# Those are paths to env files created by wizard
misago_env_path="./env/misago.env"
env_paths=(
    $misago_env_path
    "./env/postgres.env"
)

# Utility functions used by action commands
error() {
    echo -e "${RED}Error:${NORMAL} $1"
}

require_setup() {
    for env_path in "${env_paths[@]}"; do
        if [ ! -e $env_path ]; then
            if [[ $1 ]]; then
                error $1
            else
                error "You need to setup your site using \"setup\" option before you will be able to use this option."
            fi
            echo
            exit 1
        fi
    done
}

# Check if user has docker-compose
if ! command -v docker-compose >/dev/null 2>&1; then
    error "You need to have Docker installed to use this tool."
    echo
    echo "Docker release for your system can be downloaded for free from this page:"
    echo "https://www.docker.com/get-started"
    echo
    exit 1
fi

# Commands
intro() {
    echo "Usage: ./appctl [arg] ..."
    echo "Arguments grouped by type:"
    echo
    echo "Setup and upgrade:"
    echo
    echo "    ${BOLD}setup${NORMAL}             setup new Misago site."
    echo
    echo "Docker process:"
    echo
    echo "    ${BOLD}start${NORMAL}             start all containers."
    echo "    ${BOLD}stop${NORMAL}              stop all containers."
    echo "    ${BOLD}restart${NORMAL}           stop and start all docker containers."
    echo "    ${BOLD}rebuild${NORMAL}           rebuild and restart Misago container."
    echo "    ${BOLD}stats${NORMAL}             see list and stats of running docker containers."
    echo
    echo "Change configuration:"
    echo
    echo "    ${BOLD}email${NORMAL}             change email setup."
    echo "    ${BOLD}hostname${NORMAL}          change hostname setup."
    echo "    ${BOLD}locale${NORMAL}            change locale setup."
    echo "    ${BOLD}timezone${NORMAL}          change timezone setup."
    echo "    ${BOLD}sentry${NORMAL}            enable or disable Sentry (sentry.io) for logging."
    echo "    ${BOLD}debug${NORMAL}             change debug mode."
    echo "    ${BOLD}secret${NORMAL}            reset secret key."
    echo
    echo "Backup:"
    echo
    echo "    ${BOLD}backup${NORMAL}            backup and archive database and media."
    echo "    ${BOLD}restore BACKUP${NORMAL}    restore database and media from BACKUP archive."
    echo
    echo "Shortcuts:"
    echo
    echo "    ${BOLD}psql${NORMAL}          runs psql connected to database."
    echo
}

# Handle invalid argument
invalid_argument() {
    echo -e "Invalid argument: ${RED}$1${NORMAL}"
    echo "Please run this script without any arguments to see the list of available arguments."
    echo
    exit 1
}

# Run new site setup
setup() {
    # Test if env files already exist
    for env_path in "${env_paths[@]}"; do
        if [ -e $env_path ]; then
            error "Setup appears to already been completed."
            echo
            exit 1
        fi
    done
    # Run wizard to let user create env files
    python3 wizard/setup.py
    # Recheck if user completed setup
    for env_path in "${env_paths[@]}"; do
        if [ ! -e $env_path ]; then
            echo "Setup canceled."
            echo
            exit 1
        fi
    done
    # Ask user what actions to perform
    read -p "Initialize default database? [Y/n]: " initialize_default_database
    # Run docker build
    docker-compose build --pull
    if [ "$initialize_default_database" != "n" ]; then
        docker-compose run --rm misago ./.run initialize_default_database
    fi
    collectstatic
    setup_crontab
}

# Run collectstatic (uses misago-static volume) so site has loaded assets
collectstatic() {
    docker-compose run --rm misago python manage.py collectstatic --no-input
}

# Setup crontab by creating "cron_tmp" file setting path and running cron in docker
# overwriting crontab contents with file, then deleting it after it is no longer needed
set_crontab() {
    current_path=$(pwd)
    echo "30 1 * * * cd $current_path && docker-compose run --rm misago ./cron" | crontab -
}

# Start docker containers
start_containers() {
    require_setup
    docker-compose up --detach
}

# Stop docker containers
stop_containers() {
    require_setup
    docker-compose stop
}

# Restart docker containers
restart_containers() {
    require_setup
    docker-compose stop
    docker-compose up --detach
}

# Rebuild misago container
rebuild_misago_container() {
    require_setup
    docker-compose build misago
    docker-compose stop misago
    docker-compose up --detach misago
}

# Show stats for running docker containers
show_stats() {
    require_setup
    docker stats
}

# E-mail configuration
change_email() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to change email configuration."
    python3 wizard/email.py
}

# Hostname configuration
change_hostname() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to change hostname configuration."
    python3 wizard/hostname.py
}

# Locale configuration
change_locale() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to change locale configuration."
    python3 wizard/locale.py
}

# Timezone configuration
change_timezone() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to change timezone configuration."
    python3 wizard/timezone.py
}

# Sentry configuration
change_sentry() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to configure Sentry."
    python3 wizard/sentry.py
}

# Debug configuration
change_debug() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to change debug mode."
    python3 wizard/debug.py
}

# Reset secret key
reset_secret_key() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to reset secret key."
    python3 wizard/secretkey.py
}

# Create new backup
create_new_backup() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to backup data."
    docker-compose run --rm misago ./.run backup
}

# Restore from backup
restore_from_backup() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to backup data."
    docker-compose run --rm misago ./.run restore "$1"
}

# Shortcut for psql
run_psql() {
    require_setup "You need to setup your site using \"setup\" option before you will be able to use psql."
    docker-compose run --rm misago ./.run psql
}

# Command dispatcher
if [[ $1 ]]; then
    if [[ $1 = "setup" ]]; then
        setup
    elif [[ $1 = "up" ]]; then
        start_containers
    elif [[ $1 = "start" ]]; then
        start_containers
    elif [[ $1 = "stop" ]]; then
        stop_containers
    elif [[ $1 = "restart" ]]; then
        restart_containers
    elif [[ $1 = "rebuild" ]]; then
        rebuild_misago_container
    elif [[ $1 = "stats" ]]; then
        show_stats
    elif [[ $1 = "email" ]]; then
        change_email
    elif [[ $1 = "hostname" ]]; then
        change_hostname
    elif [[ $1 = "locale" ]]; then
        change_locale
    elif [[ $1 = "timezone" ]]; then
        change_timezone
    elif [[ $1 = "sentry" ]]; then
        change_sentry
    elif [[ $1 = "debug" ]]; then
        change_debug
    elif [[ $1 = "secret" ]]; then
        reset_secret_key
    elif [[ $1 = "backup" ]]; then
        create_new_backup
    elif [[ $1 = "restore" ]]; then
        restore_from_backup $2
    elif [[ $1 = "psql" ]]; then
        run_psql
    else
        invalid_argument $1
    fi
else
    intro
fi