#!/bin/bash
# appctl is an utility script for managing your Misago deployment.
# To find out what options are available, run it without any arguments.

# Text styles
RED='\033[0;31m'
BOLD=$(tput bold)
NORMAL=$(tput sgr0)

# Define env paths
# Those are paths to env files created by wizard
misago_env_path="./env/misago.env"
env_paths=(
    misago_env_path
    "./env/postgres.env"
)

# Utility functions used by action commands
error() {
    echo -e "${RED}Error:${NORMAL} $1"
}

# Check if user has docker-compose
if ! command -v docker-compose >/dev/null 2>&1; then
    error "You need to have Docker installed to use this tool."
    echo
    echo "Docker release for your system can be downloaded for free from this page:"
    echo "https://www.docker.com/get-started"
    echo
    exit 1
fi

# Commands
intro() {
    echo "Usage: ./appctl [arg] ..."
    echo "Arguments grouped by type:"
    echo
    echo "Setup and upgrade:"
    echo
    echo "    ${BOLD}setup${NORMAL}             setup new Misago site."
    echo
    echo "Change configuration:"
    echo
    echo "    ${BOLD}config email${NORMAL}      change email setup."
    echo "    ${BOLD}config locale${NORMAL}     change locale setup."
    echo "    ${BOLD}config timezone${NORMAL}   change timezone setup."
    echo "    ${BOLD}config debug${NORMAL}      change debug mode."
    echo "    ${BOLD}config secret${NORMAL}     reset secret key."
    echo
}

# Handle invalid argument
invalid_argument() {
    echo -e "Invalid argument: ${RED}$1${NORMAL}"
    echo "Please run this script without any arguments to see the list of available arguments."
    exit 1
}

# Run new site setup
setup() {
    # Test if env files already exist
    for env_path in "${env_paths[@]}"; do
        if [ -e $env_path ]; then
            error "Setup appears to already been completed."
            echo
            exit 1
        fi
    done
    # Run wizard to let user create env files
    python3 wizard/setup.py
    # Recheck if user completed setup
    for env_path in "${env_paths[@]}"; do
        if [ ! -e $env_path ]; then
            exit 1
        fi
    done
    # Initialize default database?
    read -p "Do you want to initialize database? [Y/n]: " initialize_default_database
    # Run docker build
    docker-compose build --pull
    if [ "$initialize_default_database" != "n" ]; then
        docker-compose run --rm misago ./.run initialize_default_database
    fi
}

# E-mail configuration
config_email() {
    if [ -e $misago_env_path ]; then
        python3 wizard/email.py
    else
        error "You need to setup your site using \"setup\" option before you will be able to change email configuration."
    fi
}

# Locale configuration
config_locale() {
    if [ -e $misago_env_path ]; then
        python3 wizard/locale.py
    else
        error "You need to setup your site using \"setup\" option before you will be able to change locale configuration."
    fi
}

# Timezone configuration
config_timezone() {
    if [ -e $misago_env_path ]; then
        python3 wizard/timezone.py
    else
        error "You need to setup your site using \"setup\" option before you will be able to change timezone configuration."
    fi
}

# Debug configuration
config_debug() {
    if [ -e $misago_env_path ]; then
        python3 wizard/debug.py
    else
        error "You need to setup your site using \"setup\" option before you will be able to change debug mode."
    fi
}

# Reset secret key
reset_secret_key() {
    if [ -e $misago_env_path ]; then
        python3 wizard/secretkey.py
    else
        error "You need to setup your site using \"setup\" option before you will be able to reset secret key."
    fi
}

# Command dispatcher
if [[ $1 ]]; then
    if [[ $1 = "setup" ]]; then
        setup
    elif [[ $1 = "config" ]]; then
        if [[ $2 ]]; then
            if [[ $2 = "email" ]]; then
                config_email
            elif [[ $2 = "locale" ]]; then
                config_locale
            elif [[ $2 = "timezone" ]]; then
                config_timezone
            elif [[ $2 = "debug" ]]; then
                config_debug
            elif [[ $2 = "secret" ]]; then
                reset_secret_key
            else
                invalid_argument $2
            fi
        else
            error "\"config\" command needs to be followed by name of configuration you want to change (eg. \"config email\")."
        fi
    else
        invalid_argument $1
    fi
else
    intro
fi